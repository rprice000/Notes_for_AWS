=== Step 9: Configure security-config.yaml

[start=1]
. Open the security-config.yaml file
. Add a line to the top of the file containing:

[source,yaml]
----
homeRegion: &HOME_REGION us-gov-west-1
----

[start=3]
. Set *centralSecurityServices.ebsDefaultVolumeEncryption.enable* to *true*
. Set *centralSecurityServices.s3PublicAccessBlock.enable* to *true*
. Set *centralSecurityServices.scpRevertChangesConfig.enable* to *true*
. Configure *centralSecurityServices.snsSubscriptions* with the following:

[source,yaml]
----
   snsSubscriptions: # Follow up on this in documentation.
     - level: High
       email: aws-security-high@example.com
     - level: Medium
       email: aws-security-medium@example.com
     - level: Low
       email: aws-security-low@example.com
----

[start=7]
. Make sure to change the email addresses to one’s that align with your organization
. Configure *centralSecurityServices.guardduty.enable* to *true*
. Configure *centralSecurityServices.guardduty.s3Protection.enable* to *true*
. Configure *centralSecurityServices.guardduty.exportConfiguration.enable* to *true*
. Configure *centralSecurityServices.guardduty.exportConfiguration.overrideExisting* to *true*
. Configure *centralSecurityServices.securityHub.enable* to *true*
. Configure *centralSecurityServices.securityHub.standards* with:

[source,yaml]
----
    standards:
      # for enum of names, see: https://awslabs.github.io/landing-zone-accelerator-on-aws/classes/_aws_accelerator_config.SecurityHubStandardConfig.html#name
      # add NIST 800-53r5
      - name: NIST Special Publication 800-53 Revision 5
        # https://docs.aws.amazon.com/securityhub/latest/userguide/nist-standard.html
        enable: true
        controlstoDisable: [ ]
        # disable AWS Foundational Security Best Practices v1.0.0
      - name: AWS Foundational Security Best Practices v1.0.0
        # https://docs.aws.amazon.com/securityhub/latest/userguide/fsbp-standard.html
        enable: false
        controlstoDisable: [ ]
        # disable CIS AWS Foundations Benchmark v1.2.0
      - name: CIS AWS Foundations Benchmark v1.2.0
        # https://docs.aws.amazon.com/securityhub/latest/userguide/cis-aws-foundations-benchmark.html
        enable: false
        controlstoDisable: [ ]
        # disable CIS AWS Foundations Benchmark v1.4.0
      - name: CIS AWS Foundations Benchmark v1.4.0
        # https://docs.aws.amazon.com/securityhub/latest/userguide/cis-aws-foundations-benchmark.html
        enable: false
        controlstoDisable: [ ]
        # disable PCI DSS v3.2.1
      - name: PCI DSS v3.2.1
        # https://docs.aws.amazon.com/securityhub/latest/userguide/pci-standard.html
        enable: false
        controlstoDisable: [ ]
----

[start=14]
. Configure *centralSecurityServices.ssmAutomation.documentSets* to

[source,yaml]
----
     documentSets:
       - shareTargets:
           organizationalUnits:
             - Root
         documents:
           # Calls the AWS CLI to enable access logs on a specified ELB
           - name: SSM-ELB-Enable-Logging
             template: ssm-documents/ssm-elb-enable-logging.yaml
           # Enables S3 encryption using KMS
           - name: Put-S3-Encryption
             template: ssm-documents/s3-encryption.yaml
           # Attaches instance profiles to an EC2 instance
           - name: Attach-IAM-Instance-Profile
             template: ssm-documents/attach-iam-instance-profile.yaml
           # Attaches Aws IAM Managed Policy to IAM Role
           - name: Attach-IAM-Role-Policy
             template: ssm-documents/attach-iam-role-policy.yaml
           # Disables SSH to security group
           - name: Disable-Public-SSH
             template: ssm-documents/disable-public-ssh.yaml
           # Enables IMDSV2
           - name: Configure-IMDSV2
             template: ssm-documents/configure_imdsv2.yaml
           # Remove open sec groups that not open ports
           - name: remove-open-security-groups
             template: ssm-documents/remove-open-security-group.yaml
----

[start=15]
. Configure *accessAnalyzer.enable* to *true*
. Configure *awsConfig.enableConfigurationRecorder* to *true*
. Add *awsConfig.enableDeliveryChannel* to *true*
. Add the following to *awsConfig.ruleSets*

[source,yaml]
----
  ruleSets:
    - deploymentTargets:
        organizationalUnits:
          - Root
      rules:
        #############################################################################
        # Enabling additional config rules not implemented through AWS Security Hub #
        #############################################################################
        - name: accelerator-iam-user-group-membership-check
          complianceResourceTypes:
            - AWS::IAM::User
          identifier: IAM_USER_GROUP_MEMBERSHIP_CHECK
        - name: accelerator-securityhub-enabled
          identifier: SECURITYHUB_ENABLED
        - name: accelerator-cloudtrail-enabled
          identifier: CLOUD_TRAIL_ENABLED
        - name: accelerator-cloudtrail-s3-dataevents-enabled
          identifier: CLOUDTRAIL_S3_DATAEVENTS_ENABLED
        - name: accelerator-emr-kerberos-enabled
          identifier: EMR_KERBEROS_ENABLED
        - name: accelerator-iam-group-has-users-check
          complianceResourceTypes:
            - AWS::IAM::Group
          identifier: IAM_GROUP_HAS_USERS_CHECK
        - name: accelerator-s3-bucket-policy-grantee-check
          complianceResourceTypes:
            - AWS::S3::Bucket
          identifier: S3_BUCKET_POLICY_GRANTEE_CHECK
        # Note, included in Security Hub AFBP slightly different with ports 80 and 443
        - name: accelerator-internet-gateway-authorized-vpc-only
          complianceResourceTypes:
            - AWS::EC2::InternetGateway
          identifier: INTERNET_GATEWAY_AUTHORIZED_VPC_ONLY
        - name: accelerator-iam-no-inline-policy-check
          complianceResourceTypes:
            - AWS::IAM::User
            - AWS::IAM::Role
            - AWS::IAM::Group
          identifier: IAM_NO_INLINE_POLICY_CHECK
        - name: accelerator-cloudwatch-log-group-encrypted
          identifier: CLOUDWATCH_LOG_GROUP_ENCRYPTED
        - name: accelerator-ec2-instance-detailed-monitoring-enabled
          complianceResourceTypes:
            - AWS::EC2::Instance
          identifier: EC2_INSTANCE_DETAILED_MONITORING_ENABLED
        - name: accelerator-ec2-volume-inuse-check
          inputParameters:
            deleteOnTermination: "TRUE"
          complianceResourceTypes:
            - AWS::EC2::Volume
          identifier: EC2_VOLUME_INUSE_CHECK
        - name: accelerator-cloudtrail-security-trail-enabled
          identifier: CLOUDTRAIL_SECURITY_TRAIL_ENABLED
        - name: accelerator-guardduty-non-archived-findings
          inputParameters:
            daysHighSev: "1"
            daysLowSev: "30"
            daysMediumSev: "7"
          identifier: GUARDDUTY_NON_ARCHIVED_FINDINGS
        - name: accelerator-sagemaker-endpoint-configuration-kms-key-configured
          identifier: SAGEMAKER_ENDPOINT_CONFIGURATION_KMS_KEY_CONFIGURED
        - name: accelerator-sagemaker-notebook-instance-kms-key-configured
          identifier: SAGEMAKER_NOTEBOOK_INSTANCE_KMS_KEY_CONFIGURED
        - name: accelerator-dynamodb-table-encrypted-kms
          complianceResourceTypes:
            - AWS::DynamoDB::Table
          identifier: DYNAMODB_TABLE_ENCRYPTED_KMS

        # NIST 800-53-rev5 Conformance Pack - Additional 15
        - name: accelerator-account-part-of-organizations
          identifier: ACCOUNT_PART_OF_ORGANIZATIONS
        - name: accelerator-dynamodb-throughput-limit-check
          identifier: DYNAMODB_THROUGHPUT_LIMIT_CHECK
        - name: accelerator-ebs-optimized-instance
          complianceResourceTypes:
            - AWS::EC2::Instance
          identifier: EBS_OPTIMIZED_INSTANCE
        - name: accelerator-no-unrestricted-route-to-igw
          complianceResourceTypes:
            - AWS::EC2::RouteTable
          identifier: NO_UNRESTRICTED_ROUTE_TO_IGW
        - name: accelerator-secretsmanager-using-cmk
          complianceResourceTypes:
            - AWS::SecretsManager::Secret
          identifier: SECRETSMANAGER_USING_CMK

    # Optional Config rules to check for resources protected by backups.
    - deploymentTargets:
        organizationalUnits: []
      rules:
        - name: accelerator-aurora-resources-protected-by-backup-plan
          complianceResourceTypes:
            - AWS::RDS::DBCluster
          identifier: AURORA_RESOURCES_PROTECTED_BY_BACKUP_PLAN
        - name: accelerator-backup-plan-min-frequency-and-min-retention-check
          complianceResourceTypes:
            - AWS::Backup::BackupPlan
          identifier: BACKUP_PLAN_MIN_FREQUENCY_AND_MIN_RETENTION_CHECK
        - name: accelerator-backup-recovery-point-encrypted
          complianceResourceTypes:
            - AWS::Backup::RecoveryPoint
          identifier: BACKUP_RECOVERY_POINT_ENCRYPTED
        - name: accelerator-backup-recovery-point-manual-deletion-disabled
          complianceResourceTypes:
            - AWS::Backup::BackupVault
          identifier: BACKUP_RECOVERY_POINT_MANUAL_DELETION_DISABLED
        - name: accelerator-ec2-resources-protected-by-backup-plan
          complianceResourceTypes:
            - AWS::EC2::Instance
          identifier: EC2_RESOURCES_PROTECTED_BY_BACKUP_PLAN
----

[start=19]
. Replace the entire *cloudWatch* configuration with:

[source,yaml]
----
cloudWatch:
  metricSets:
    - regions:
        - *HOME_REGION
      #####################################
      # With landing zone version 3.0, AWS Control Tower now supports organization-level AWS CloudTrail trails.                                          #
      # Going forward from landing zone 3.0, AWS Control Tower no longer will support account-level trails that AWS manages.                             #
      # If your environment runs on prior version (3.0) of landing zone, you can change deployment targets for the metrics to Root organizational units  #
      # Metrics deployment target should be management account for environment with landing zone version 3.0                                             #
      # Please refer https://docs.aws.amazon.com/controltower/latest/userguide/2022-all.html#version-3.0 for more information                            #
      #####################################
      deploymentTargets:
        accounts:
          - Management
      metrics:
        # CIS 1.1 – Avoid the use of the "root" account
        - filterName: RootAccountMetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs # change the name of log group
          filterPattern: '{$.userIdentity.type="Root" && $.userIdentity.invokedBy NOT EXISTS && $.eventType !="AwsServiceEvent"}'
          metricNamespace: LogMetrics
          metricName: RootAccount
          metricValue: "1"
        # CIS 3.1 – Ensure a log metric filter and alarm exist for unauthorized API calls
        - filterName: UnauthorizedAPICallsMetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs
          filterPattern: '{($.errorCode="*UnauthorizedOperation") || ($.errorCode="AccessDenied*")}'
          metricNamespace: LogMetrics
          metricName: UnauthorizedAPICalls
          metricValue: "1"
        # CIS 3.2 – Ensure a log metric filter and alarm exist for AWS Management Console sign-in without MFA
        - filterName: ConsoleSigninWithoutMFAMetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs
          filterPattern: '{($.eventName = "ConsoleLogin") && ($.additionalEventData.MFAUsed != "Yes") && ($.userIdentity.type = "IAMUser") && ($.responseElements.ConsoleLogin = "Success")}'
          metricNamespace: LogMetrics
          metricName: ConsoleSigninWithoutMFA
          metricValue: "1"
        # CIS 3.3 – Ensure a log metric filter and alarm exist for usage of "root" account
        - filterName: MetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs
          filterPattern: '{$.userIdentity.type="Root" && $.userIdentity.invokedBy NOT EXISTS && $.eventType !="AwsServiceEvent"}'
          metricNamespace: LogMetrics
          metricName: RootAccountUsage
          metricValue: "1"
        # CIS 3.4 – Ensure a log metric filter and alarm exist for IAM policy changes
        - filterName: IAMPolicyChangesMetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs
          filterPattern: "{($.eventName=DeleteGroupPolicy) || ($.eventName=DeleteRolePolicy) || ($.eventName=DeleteUserPolicy) || ($.eventName=PutGroupPolicy) || ($.eventName=PutRolePolicy) || ($.eventName=PutUserPolicy) || ($.eventName=CreatePolicy) || ($.eventName=DeletePolicy) || ($.eventName=CreatePolicyVersion) || ($.eventName=DeletePolicyVersion) || ($.eventName=AttachRolePolicy) || ($.eventName=DetachRolePolicy) || ($.eventName=AttachUserPolicy) || ($.eventName=DetachUserPolicy) || ($.eventName=AttachGroupPolicy) || ($.eventName=DetachGroupPolicy)}"
          metricNamespace: LogMetrics
          metricName: IAMPolicyChanges
          metricValue: "1"
        # CIS 3.5 – Ensure a log metric filter and alarm exist for CloudTrail configuration changes
        - filterName: CloudTrailChangesMetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs
          filterPattern: "{($.eventName=CreateTrail) || ($.eventName=UpdateTrail) || ($.eventName=DeleteTrail) || ($.eventName=StartLogging) || ($.eventName=StopLogging)}"
          metricNamespace: LogMetrics
          metricName: CloudTrailChanges
          metricValue: "1"
        # CIS 3.6 – Ensure a log metric filter and alarm exist for AWS Management Console authentication failures
        - filterName: ConsoleAuthenticationFailureMetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs
          filterPattern: '{($.eventName=ConsoleLogin) && ($.errorMessage="Failed authentication")}'
          metricNamespace: LogMetrics
          metricName: ConsoleAuthenticationFailure
          metricValue: "1"
        # CIS 3.7 – Ensure a log metric filter and alarm exist for disabling or scheduled deletion of customer created CMKs
        - filterName: DisableOrDeleteCMKMetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs
          filterPattern: "{($.eventSource=kms.amazonaws.com) && (($.eventName=DisableKey) || ($.eventName=ScheduleKeyDeletion))}"
          metricNamespace: LogMetrics
          metricName: DisableOrDeleteCMK
          metricValue: "1"
        # CIS 3.8 – Ensure a log metric filter and alarm exist for S3 bucket policy changes
        - filterName: S3BucketPolicyChangesMetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs
          filterPattern: "{($.eventSource=s3.amazonaws.com) && (($.eventName=PutBucketAcl) || ($.eventName=PutBucketPolicy) || ($.eventName=PutBucketCors) || ($.eventName=PutBucketLifecycle) || ($.eventName=PutBucketReplication) || ($.eventName=DeleteBucketPolicy) || ($.eventName=DeleteBucketCors) || ($.eventName=DeleteBucketLifecycle) || ($.eventName=DeleteBucketReplication))}"
          metricNamespace: LogMetrics
          metricName: S3BucketPolicyChanges
          metricValue: "1"
        # CIS 3.9 – Ensure a log metric filter and alarm exist for AWS Config configuration changes
        - filterName: AWSConfigChangesMetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs
          filterPattern: "{($.eventSource=config.amazonaws.com) && (($.eventName=StopConfigurationRecorder) || ($.eventName=DeleteDeliveryChannel) || ($.eventName=PutDeliveryChannel) || ($.eventName=PutConfigurationRecorder))}"
          metricNamespace: LogMetrics
          metricName: AWSConfigChanges
          metricValue: "1"
        # CIS 3.10 – Ensure a log metric filter and alarm exist for security group changes
        - filterName: SecurityGroupChangesMetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs
          filterPattern: "{($.eventName=AuthorizeSecurityGroupIngress) || ($.eventName=AuthorizeSecurityGroupEgress) || ($.eventName=RevokeSecurityGroupIngress) || ($.eventName=RevokeSecurityGroupEgress) || ($.eventName=CreateSecurityGroup) || ($.eventName=DeleteSecurityGroup)}"
          metricNamespace: LogMetrics
          metricName: SecurityGroupChanges
          metricValue: "1"
        # CIS 3.11 – Ensure a log metric filter and alarm exist for changes to Network Access Control Lists (NACL)
        - filterName: NetworkACLChangesMetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs
          filterPattern: "{($.eventName=CreateNetworkAcl) || ($.eventName=CreateNetworkAclEntry) || ($.eventName=DeleteNetworkAcl) || ($.eventName=DeleteNetworkAclEntry) || ($.eventName=ReplaceNetworkAclEntry) || ($.eventName=ReplaceNetworkAclAssociation)}"
          metricNamespace: LogMetrics
          metricName: NetworkACLChanges
          metricValue: "1"
        # CIS 3.12 – Ensure a log metric filter and alarm exist for changes to network gateways
        - filterName: NetworkGatewayChangesMetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs
          filterPattern: "{($.eventName=CreateCustomerGateway) || ($.eventName=DeleteCustomerGateway) || ($.eventName=AttachInternetGateway) || ($.eventName=CreateInternetGateway) || ($.eventName=DeleteInternetGateway) || ($.eventName=DetachInternetGateway)}"
          metricNamespace: LogMetrics
          metricName: NetworkGatewayChanges
          metricValue: "1"
        # CIS 3.13 – Ensure a log metric filter and alarm exist for route table changes
        - filterName: RouteTableChangesMetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs
          filterPattern: "{($.eventName=CreateRoute) || ($.eventName=CreateRouteTable) || ($.eventName=ReplaceRoute) || ($.eventName=ReplaceRouteTableAssociation) || ($.eventName=DeleteRouteTable) || ($.eventName=DeleteRoute) || ($.eventName=DisassociateRouteTable)}"
          metricNamespace: LogMetrics
          metricName: RouteTableChanges
          metricValue: "1"
        # CIS 3.14 – Ensure a log metric filter and alarm exist for VPC changes
        - filterName: VPCChangesMetricFilter
          logGroupName: aws-accelerator-cloudtrail-logs
          filterPattern: "{($.eventName=CreateVpc) || ($.eventName=DeleteVpc) || ($.eventName=ModifyVpcAttribute) || ($.eventName=AcceptVpcPeeringConnection) || ($.eventName=CreateVpcPeeringConnection) || ($.eventName=DeleteVpcPeeringConnection) || ($.eventName=RejectVpcPeeringConnection) || ($.eventName=AttachClassicLinkVpc) || ($.eventName=DetachClassicLinkVpc) || ($.eventName=DisableVpcClassicLink) || ($.eventName=EnableVpcClassicLink)}"
          metricNamespace: LogMetrics
          metricName: VPCChanges
          metricValue: "1"
  alarmSets:
    - regions:
        - *HOME_REGION
      #####################################
      # With landing zone version 3.0, AWS Control Tower now supports organization-level AWS CloudTrail trails.                                          #
      # Going forward from landing zone 3.0, AWS Control Tower no longer will support account-level trails that AWS manages.                             #
      # If your environment runs on prior version (3.0) of landing zone, you can change deployment targets for the metrics to Root organizational units  #
      # Metrics deployment target should be management account for environment with landing zone version 3.0                                             #
      # Please refer https://docs.aws.amazon.com/controltower/latest/userguide/2022-all.html#version-3.0 for more information                            #
      #####################################
      deploymentTargets:
        accounts:
          - Management
      alarms:
        # CIS 1.1 – Avoid the use of the "root" account
        - alarmName: CIS-1.1-RootAccountUsage
          alarmDescription: Alarm for usage of "root" account
          snsTopicName: Security
          metricName: RootAccountUsage
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Sum
          threshold: 1
          treatMissingData: notBreaching
        # CIS 3.1 – Ensure a log metric filter and alarm exist for unauthorized API calls
        - alarmName: CIS-3.1-UnauthorizedAPICalls
          alarmDescription: Alarm for unauthorized API calls
          snsTopicName: Security
          metricName: UnauthorizedAPICalls
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Average
          threshold: 5
          treatMissingData: notBreaching
        # CIS 3.2 – Ensure a log metric filter and alarm exist for AWS Management Console sign-in without MFA
        - alarmName: CIS-3.2-ConsoleSigninWithoutMFA
          alarmDescription: Alarm for AWS Management Console sign-in without MFA
          snsTopicName: Security
          metricName: ConsoleSigninWithoutMFA
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Sum
          threshold: 1
          treatMissingData: notBreaching
        # CIS 3.3 – Ensure a log metric filter and alarm exist for usage of "root" account
        - alarmName: CIS-3.3-RootAccountUsage
          alarmDescription: Alarm for usage of "root" account
          snsTopicName: Security
          metricName: RootAccountUsage
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Sum
          threshold: 1
          treatMissingData: notBreaching
        # CIS 3.4 – Ensure a log metric filter and alarm exist for IAM policy changes
        - alarmName: CIS-3.4-IAMPolicyChanges
          alarmDescription: Alarm for IAM policy changes
          snsTopicName: Security
          metricName: IAMPolicyChanges
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Average
          threshold: 1
          treatMissingData: notBreaching
        # CIS 3.5 – Ensure a log metric filter and alarm exist for CloudTrail configuration changes
        - alarmName: CIS-3.5-CloudTrailChanges
          alarmDescription: Alarm for CloudTrail configuration changes
          snsTopicName: Security
          metricName: CloudTrailChanges
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Sum
          threshold: 1
          treatMissingData: notBreaching
        # CIS 3.6 – Ensure a log metric filter and alarm exist for AWS Management Console authentication failures
        - alarmName: CIS-3.6-ConsoleAuthenticationFailure
          alarmDescription: Alarm exist for AWS Management Console authentication failures
          snsTopicName: Security
          metricName: ConsoleAuthenticationFailure
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Sum
          threshold: 1
          treatMissingData: notBreaching
        # CIS 3.7 – Ensure a log metric filter and alarm exist for disabling or scheduled deletion of customer created CMKs
        - alarmName: CIS-3.7-DisableOrDeleteCMK
          alarmDescription: Alarm for disabling or scheduled deletion of customer created CMKs
          snsTopicName: Security
          metricName: DisableOrDeleteCMK
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Sum
          threshold: 1
          treatMissingData: notBreaching
        # CIS 3.8 – Ensure a log metric filter and alarm exist for S3 bucket policy changes
        - alarmName: CIS-3.8-S3BucketPolicyChanges.
          alarmDescription: Alarm for S3 bucket policy changes
          snsTopicName: Security
          metricName: S3BucketPolicyChanges
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Average
          threshold: 1
          treatMissingData: notBreaching
        # CIS 3.9 – Ensure a log metric filter and alarm exist for AWS Config configuration changes
        - alarmName: CIS-3.9-AWSConfigChanges
          alarmDescription: Alarm for AWS Config configuration changes
          snsTopicName: Security
          metricName: AWSConfigChanges
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Sum
          threshold: 1
          treatMissingData: notBreaching
        # CIS 3.10 – Ensure a log metric filter and alarm exist for security group changes
        - alarmName: CIS-3.10-SecurityGroupChanges
          alarmDescription: Alarm for security group changes
          snsTopicName: Security
          metricName: SecurityGroupChanges
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Sum
          threshold: 1
          treatMissingData: notBreaching
        # CIS 3.11 – Ensure a log metric filter and alarm exist for changes to Network Access Control Lists (NACL)
        - alarmName: CIS-3.11-NetworkACLChanges
          alarmDescription: Alarm for changes to Network Access Control Lists (NACL)
          snsTopicName: Security
          metricName: NetworkACLChanges
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Sum
          threshold: 1
          treatMissingData: notBreaching
        # CIS 3.12 – Ensure a log metric filter and alarm exist for changes to network gateways
        - alarmName: CIS-3.12-NetworkGatewayChanges
          alarmDescription: Alarm for changes to network gateways
          snsTopicName: Security
          metricName: NetworkGatewayChanges
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Sum
          threshold: 1
          treatMissingData: notBreaching
        # CIS 3.13 – Ensure a log metric filter and alarm exist for route table changes
        - alarmName: CIS-3.13-RouteTableChanges
          alarmDescription: Alarm for route table changes
          snsTopicName: Security
          metricName: RouteTableChanges
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Average
          threshold: 1
          treatMissingData: notBreaching
        # CIS 3.14 – Ensure a log metric filter and alarm exist for VPC changes
        - alarmName: CIS-3.14-VPCChanges
          alarmDescription: Alarm for VPC changes
          snsTopicName: Security
          metricName: VPCChanges
          namespace: LogMetrics
          comparisonOperator: GreaterThanOrEqualToThreshold
          evaluationPeriods: 1
          period: 300
          statistic: Sum
          threshold: 1
          treatMissingData: notBreaching
----

[start=20]
. Save the file
. Create the file *ssm-documents/ssm-elb-enable-logging.yaml* and paste the following contents:

[source,yaml]
----
description: Enable logging on Elastic Load-Balancer
schemaVersion: "0.3"
assumeRole: "{{ AutomationAssumeRole }}"
parameters:
  LogDestination:
    type: String
  LoadBalancerArn:
    type: String
  AutomationAssumeRole:
    type: String
mainSteps:
  - name: getAccount
    action: "aws:executeAwsApi"
    inputs:
      Service: sts
      Api: get_caller_identity
    outputs:
      - Name: Id
        Selector: $.Account
        Type: String
  - name: getLoadBalancer
    action: "aws:executeAwsApi"
    inputs:
      Service: elbv2
      Api: describe_load_balancers
      LoadBalancerArns:
        - "{{ LoadBalancerArn }}"
    outputs:
      - Name: Name
        Selector: $.LoadBalancers[0].LoadBalancerName
        Type: String
  - name: enableLogging
    action: "aws:executeAwsApi"
    inputs:
      Service: elbv2
      Api: modify_load_balancer_attributes
      LoadBalancerArn: "{{ LoadBalancerArn }}"
      Attributes:
        - Key: access_logs.s3.enabled
          Value: "true"
        - Key: access_logs.s3.bucket
          Value: "{{ LogDestination }}"
        - Key: access_logs.s3.prefix
          Value: "{{ getAccount.Id }}/elb-{{ getLoadBalancer.Name }}"
----
[start=22]
. Create the file *ssm-documents/s3-encryption.yaml* and paste the following contents:
[source,yaml]
----
description: Enables Encryption on S3 Bucket
schemaVersion: "0.3"
assumeRole: "{{ AutomationAssumeRole }}"
parameters:
  BucketName:
    type: String
    description: (Required) The name of the S3 Bucket whose content will be encrypted.
  KMSMasterKey:
    type: String
    description: (Optional) AWS Key Management Service (KMS) customer master key ARN to use for the default encryption.
  AutomationAssumeRole:
    type: String
    description: (Optional) The ARN of the role that allows Automation to perform the actions on your behalf.
    default: ""
mainSteps:
  - name: PutBucketEncryption
    action: aws:executeAwsApi
    inputs:
      Service: s3
      Api: PutBucketEncryption
      Bucket: "{{BucketName}}"
      ServerSideEncryptionConfiguration:
        Rules:
          - ApplyServerSideEncryptionByDefault:
              SSEAlgorithm: "aws:kms"
              KMSMasterKeyID: "{{KMSMasterKey}}"
    isEnd: true
----
[start=23]
. Create the file *ssm-documents/attach-iam-instance-profile.yaml* and paste the following contents:

[source,yaml]
----
description: Associate AWS Iam Instance Profile to EC2 Instance
schemaVersion: "0.3"
assumeRole: "{{ AutomationAssumeRole }}"
parameters:
  IamInstanceProfile:
    type: String
  InstanceId:
    type: String
  AutomationAssumeRole:
    type: String
mainSteps:
  - name: associateIamProfile
    action: "aws:executeAwsApi"
    inputs:
      Service: ec2
      Api: associate_iam_instance_profile
      IamInstanceProfile:
        Name: "{{ IamInstanceProfile }}"
      InstanceId: "{{ InstanceId }}"
----
[start=24]
. Create the file *ssm-documents/attach-iam-role-policy.yaml* and paste the following contents:
[source,yaml]
----
description: IAM Role Policy
 schemaVersion: "0.3"
 assumeRole: "{{ AutomationAssumeRole }}"
 parameters:
   ResourceId:
     type: String
   AWSManagedPolicies:
     type: StringList
   CustomerManagedPolicies:
     type: StringList
     minItems: 0
     default: []
   AutomationAssumeRole:
     type: String
 mainSteps:
   - name: attachPolicy
     action: "aws:executeScript"
     inputs:
       Runtime: python3.7
       Handler: script_handler
       Script: |-
         import boto3
         partition = boto3.client("sts").get_caller_identity()['Arn'].split(":")[1]
         iam = boto3.client("iam")
         config = boto3.client("config")
         def script_handler(events, context):
           resource_id = events["ResourceId"]
           response = config.batch_get_resource_config(
             resourceKeys=[{
               'resourceType': 'AWS::IAM::Role',
               'resourceId': resource_id
             }]
           )
           role_name = response["baseConfigurationItems"][0]['resourceName']
           aws_policy_names = events["AWSManagedPolicies"]
           customer_policy_names = events["CustomerManagedPolicies"]
           for policy in aws_policy_names:
             iam.attach_role_policy(
               PolicyArn="arn:%s:iam::aws:policy/%s" %(partition, policy),
               RoleName=role_name
             )
           for policy in customer_policy_names:
             iam.attach_role_policy(
               PolicyArn=policy,
               RoleName=role_name
             )
       InputPayload:
         ResourceId: "{{ ResourceId }}"
         AWSManagedPolicies: "{{ AWSManagedPolicies }}"
         CustomerManagedPolicies: "{{ CustomerManagedPolicies }}"
----
[start=25]
. Create the file *ssm-documents/disable-public-ssh.yaml* and paste the following contents:
[source,yaml]
----
description: Disable SSH and RDP ports opened to IP address specified, or to all addresses if no address is specified. Similar to the [RevokeSecurityGroupIngress](https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_RevokeSecurityGroupIngress.html) API, the security group must have existing rules specifically on the SSH and RDP ports in order for ingress to be disabled.
 schemaVersion: "0.3"
 assumeRole: "{{ AutomationAssumeRole }}"
 parameters:
   GroupId:
     type: String
     description: (Optional) Security Group ID
     # allowedPattern: ^([s][g]\-)([0-9a-f]){1,}$
   IpAddressToBlock:
     type: String
     description: (Optional) Additional Ipv4 or Ipv6 address to block access from (ex:1.2.3.4/32)
     allowedPattern: (^$)|^((25[0-5]|(2[0-4]\d|[0-1]?\d?\d)(\.(25[0-5]|2[0-4]\d|[0-1]?\d?\d)){3})|(^((?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)?)::((?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)?))|(^(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}))\/(25[0-5]|2[0-4]\d|[0-1]?\d?\d)$
     default: ""
   AutomationAssumeRole:
     type: String
     description: (Optional) The ARN of the role that allows Automation to perform the actions on your behalf.
     default: ""
 mainSteps:
   - name: DisableSSHFromIpV4
     action: aws:executeAwsApi
     inputs:
       Service: ec2
       Api: RevokeSecurityGroupIngress
       GroupId: "{{GroupId}}"
       IpPermissions:
         - IpProtocol: tcp
           FromPort: 22
           ToPort: 22
           IpRanges:
             - CidrIp: 0.0.0.0/0
     onFailure: Continue
   - name: DisableSSHFromIpV6
     action: "aws:executeAwsApi"
     inputs:
       Service: ec2
       Api: RevokeSecurityGroupIngress
       GroupId: "{{GroupId}}"
       IpPermissions:
         - IpProtocol: tcp
           FromPort: 22
           ToPort: 22
           Ipv6Ranges:
             - CidrIpv6: "::/0"
     isEnd: true
     onFailure: Continue
----
[start=26]
. Create the file *ssm-documents/configure_imdsv2.yaml* and paste the following contents:

[source,yaml]
----
schemaVersion: "0.3"
description: |
  ### Document Name - AWSConfigRemediation-EnforceEC2InstanceIMDSv2

  ## What does this document do?
  This document is used to enforce Amazon Elastic Compute Cloud (Amazon EC2) instance metadata version to Instance Metadata Service Version 2 (IMDSv2) on a given Amazon EC2 instance using [ModifyInstanceMetadataOptions](https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_ModifyInstanceMetadataOptions.html) API.

  ## Input Parameters
  * AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.
  * InstanceId: (Required) The ID of the Amazon EC2 instance.

  ## Output Parameters
  * ModifyInstanceMetadataOptions.Output: The standard HTTP response from the ModifyInstanceMetadataOptions API.

assumeRole: "{{ AutomationAssumeRole }}"
parameters:
  AutomationAssumeRole:
    type: String
    description: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.
    allowedPattern: ^arn:aws[a-z0-9-]*:iam::\d{12}:role\/[\w-\/.@+=,]{1,1017}$
  InstanceId:
    type: String
    description: The ID of the Amazon EC2 instance.
    allowedPattern: ^i-[a-z0-9]{17}$|^i-[a-z0-9]{8}$
outputs:
  - ModifyInstanceMetadataOptions.Output
mainSteps:
  - name: ModifyInstanceMetadataOptions
    action: "aws:executeAwsApi"
    description: |
      ## ModifyInstanceMetadataOptions
      Modifies the instance metadata options on a running or stopped instance.
      ## Outputs
      * Output: The standard HTTP response from the ModifyInstanceMetadataOptions API.
    timeoutSeconds: 600
    isEnd: false
    inputs:
      Service: ec2
      Api: ModifyInstanceMetadataOptions
      InstanceId: "{{ InstanceId }}"
      HttpTokens: "required"
    outputs:
      - Name: Output
        Selector: $
        Type: StringMap
  - name: VerifyEC2IMDSv2Enforced
    action: "aws:assertAwsResourceProperty"
    timeoutSeconds: 600
    isEnd: true
    description: |
      ## DescribeInstances
      Checks that IMDSv2 is enforced on the Amazon EC2 Instance.
    inputs:
      Service: ec2
      Api: DescribeInstances
      InstanceIds:
        - "{{ InstanceId }}"
      PropertySelector: $.Reservations[0].Instances[0].MetadataOptions.HttpTokens
      DesiredValues:
        - required
----

[start=27]
. Create the file *ssm-documents/remove-open-security-group.yaml* and paste the following contents:

[source,yaml]
----
schemaVersion: "0.3"
 description: |
   ### Document Name - AWSConfigRemediation-RemoveUnrestrictedSourceIngressRules

   ## What does this document do?
   This runbook removes all ingress rules from the security group you specify that allow traffic from all source addresses using the [RevokeSecurityGroupIngress](https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_RevokeSecurityGroupIngress.html) API.


   ## Input Parameters
   * GroupId: (Required) The ID of the security group that you want to remove ingress rules that allow traffic from all source addresses from.
   * AutomationAssumeRole: (Required) The Amazon Resource Name (ARN) of the AWS Identity and Access Management (IAM) role that allows Systems Manager Automation to perform the actions on your behalf.

   ## Output Parameters
   * RemoveUnrestrictedIngressRulesAndVerify.Response - The standard HTTP response from the RevokeSecurityGroupIngress API.

 assumeRole: "{{ AutomationAssumeRole }}"
 parameters:
   AutomationAssumeRole:
     type: String
     description: (Required) The Amazon Resource Name (ARN) of the AWS Identity and Access Management (IAM) role that allows Systems Manager Automation to perform the actions on your behalf.
     allowedPattern: ^arn:aws[a-z0-9-]*:iam::\d{12}:role\/[\w-\/.@+=,]{1,1017}$
   GroupId:
     type: String
     description: (Required) The ID of the security group that you want to remove ingress rules that allow traffic from all source addresses from.
     allowedPattern: ^sg-[a-z0-9]+$

 outputs:
   - RemoveUnrestrictedIngressRulesAndVerify.Response
 mainSteps:
   - name: RemoveUnrestrictedIngressRulesAndVerify
     action: aws:executeScript
     timeoutSeconds: 600
     isEnd: true
     description: |
       ## RemoveUnrestrictedIngressRulesAndVerify
       Removes all ingress rules that allow traffic from all source addresses from the security group you specified in the GroupId parameter and verifies successful rules removal.
       ## Outputs
       * Response: The standard HTTP response from the RevokeSecurityGroupIngress API.
     inputs:
       Runtime: python3.7
       Handler: remove_sg_unrestricted_ingress_rules
       InputPayload:
         GroupId: "{{ GroupId }}"
       Script: |-
         import boto3
         def remove_unrestricted_ingress_rules_ipv4(ec2, security_group_id):
           paginator = ec2.get_paginator('describe_security_groups')
           response_iterator = paginator.paginate(
           Filters=[ {'Name': 'ip-permission.cidr', 'Values': [ '0.0.0.0/0' ] },],
           GroupIds=[security_group_id]
           )

           ip_permissions = []
           for sgs in response_iterator:
             for sg in sgs.get('SecurityGroups'):
               for ip in sg.get('IpPermissions'):
                 for rule in ip.get('IpRanges'):
                   if(rule['CidrIp'] == '0.0.0.0/0'):
                     permissions_dict = {'IpProtocol': ip['IpProtocol'], 'IpRanges': [{'CidrIp': '0.0.0.0/0'}]}
                     if not ip.get("FromPort") is None:
                       permissions_dict["FromPort"] = ip["FromPort"]
                     if not ip.get("ToPort") is None:
                       permissions_dict["ToPort"] = ip["ToPort"]
                     ip_permissions.append(permissions_dict)
           if ip_permissions:
             return ec2.revoke_security_group_ingress(GroupId=security_group_id, IpPermissions=ip_permissions)

         def remove_unrestricted_ingress_rules_ipv6(ec2, security_group_id):
             paginator = ec2.get_paginator('describe_security_groups')
             response_iterator = paginator.paginate(
             Filters=[ {'Name': 'ip-permission.ipv6-cidr', 'Values': [ '::/0' ] },],
             GroupIds=[security_group_id]
             )

             ip_permissions = []
             for sgs in response_iterator:
               for sg in sgs.get('SecurityGroups'):
                 for ip in sg.get('IpPermissions'):
                   for rule in ip.get('Ipv6Ranges'):
                     if(rule['CidrIpv6'] == '::/0'):
                       permissions_dict = {'IpProtocol': ip['IpProtocol'], 'Ipv6Ranges': [{'CidrIpv6': '::/0'}]}
                       if not ip.get("FromPort") is None:
                         permissions_dict["FromPort"] = ip["FromPort"]
                       if not ip.get("ToPort") is None:
                         permissions_dict["ToPort"] = ip["ToPort"]
                       ip_permissions.append(permissions_dict)
             if ip_permissions:
                 return ec2.revoke_security_group_ingress(GroupId=security_group_id, IpPermissions=ip_permissions)

         def verify_sg_unrestricted_rules_removed(ec2, security_group_id):
             error_message = f"Verification Failed. Security Group {security_group_id} unrestricted ingress rules not removed "

             unrestricted_ingress_rules_ipv4 = ec2.describe_security_groups(GroupIds=[ security_group_id ], Filters=[  {'Name': 'ip-permission.cidr','Values': ['0.0.0.0/0' ]} ])
             if unrestricted_ingress_rules_ipv4['SecurityGroups']:
               raise Exception(error_message)

             unrestricted_ingress_rules_ipv6 = ec2.describe_security_groups(GroupIds=[ security_group_id ], Filters=[ {'Name': 'ip-permission.ipv6-cidr','Values': ['::/0' ]} ])
             if unrestricted_ingress_rules_ipv6['SecurityGroups']:
               raise Exception(error_message)

         def remove_sg_unrestricted_ingress_rules(event, context):

             ec2 = boto3.client('ec2')
             security_group_id = event['GroupId']
             ipv4_response = remove_unrestricted_ingress_rules_ipv4(ec2, security_group_id)
             ipv6_response = remove_unrestricted_ingress_rules_ipv6(ec2, security_group_id)

             verify_sg_unrestricted_rules_removed(ec2, security_group_id)

             response = []
             if ipv4_response:
               response.append(ipv4_response)
             if ipv6_response:
               response.append(ipv6_response)
             return response

     outputs:
       - Name: Response
         Selector: $.Payload
         Type: MapList
----

This completes the configuration of the *security-config.yaml* file.