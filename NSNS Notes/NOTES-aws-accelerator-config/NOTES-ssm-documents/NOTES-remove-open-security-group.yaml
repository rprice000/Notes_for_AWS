# This document removes overly permissive security group ingress rules (0.0.0.0/0 and ::/0)
schemaVersion: '0.3'
description: |
  ## Document Name - remove-open-security-group
  This automation removes open ingress rules (IPv4 0.0.0.0/0 or IPv6 ::/0) from a security group.
  It's used to enforce tighter access controls.

assumeRole: '{{ AutomationAssumeRole }}'  # IAM role to assume for executing this document

parameters:
  GroupId:
    type: String  # Security group ID to modify
  AutomationAssumeRole:
    type: String  # Role used to perform actions
    default: ''

mainSteps:
  - name: RemoveOpenSecurityGroupRule
    action: aws:executeAwsApi  # Directly calls AWS EC2 API
    inputs:
      Service: ec2
      Api: RevokeSecurityGroupIngress
      GroupId: '{{ GroupId }}'
      IpPermissions:
        - IpProtocol: '-1'  # All protocols
          IpRanges:
            - CidrIp: 0.0.0.0/0  # Match and remove open IPv4 rule
          Ipv6Ranges:
            - CidrIpv6: '::/0'   # Match and remove open IPv6 rule
    isEnd: true  # Ends execution after this step
